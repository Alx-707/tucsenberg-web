---
paths:
  - "messages/**/*.json"
  - "src/i18n/**/*"
---

# Internationalization (i18n)

## Framework

- **Library**: next-intl
- **Locales**: `en`, `zh` (default: `en`)

## Translation Files

```
messages/
├── en/critical.json    # Above-the-fold, SEO-critical
├── en/deferred.json    # Below-the-fold, lazy-loaded
├── zh/critical.json
├── zh/deferred.json
└── {en,zh}.json        # Vitest mocks (merged files)
```

## Using Translations

### Server Components
```typescript
import { getTranslations } from 'next-intl/server';

const t = await getTranslations('products');
return <h1>{t('pageTitle')}</h1>;

// With explicit locale (for generateMetadata)
const t = await getTranslations({ locale, namespace: 'products' });
```

### Client Components
```typescript
'use client';
import { useTranslations } from 'next-intl';

const t = useTranslations('products.card');
return <span>{t('moq')}</span>;
```

### Rich Text
```typescript
t.rich('message', { bold: (chunks) => <strong>{chunks}</strong> });
t.has('someKey'); // Check existence
```

## Adding Translations

1. Add keys to both `en/` and `zh/` files
2. Keep structure identical across locales
3. Run `pnpm validate:translations`
4. Use nested keys: `namespace.section.key`

**Rule**: Namespace keys **cannot contain `.`**

## Key Files

| File | Purpose |
|------|---------|
| `src/i18n/request.ts` | Message loading |
| `src/i18n/routing.ts` | Locale config |
| `src/lib/load-messages.ts` | Message loader utilities |

## Cache Components Compatibility

### Required: `setRequestLocale`

**IMPORTANT**: Must call `setRequestLocale(locale)` in `[locale]/layout.tsx`:

```typescript
import { setRequestLocale } from 'next-intl/server';

export default async function LocaleLayout({ children, params }) {
  const { locale } = await params;
  setRequestLocale(locale); // Required for Cache Components
  // ...
}
```

### Forbidden in `"use cache"`

**Never use request-dependent APIs in cached segments**:

```typescript
// ❌ Error: reads request context
async function getCachedContent() {
  'use cache';
  const t = await getTranslations('home'); // Will fail!
}

// ✅ Correct: explicit locale parameter
async function getCachedContent(locale: 'en' | 'zh') {
  'use cache';
  cacheLife('days');
  const t = await getTranslations({ locale, namespace: 'home' });
}
```

### Safe APIs for `"use cache"`

| API | Safe | Notes |
|-----|------|-------|
| `getTranslations({ locale, namespace })` | ✅ | Explicit locale |
| `loadCriticalMessages(locale)` | ✅ | Explicit locale |
| `getTranslations()` (no args) | ❌ | Reads request |
| `getLocale()` | ❌ | Reads request |
